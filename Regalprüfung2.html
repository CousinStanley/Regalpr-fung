<%@ Page Language="C#" %>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regalprüfung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
        }

        /* Grund-Container */
        .login-container, .welcome-container, .regal-container, .profile-container {
            display: none;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: white;
            margin: 20px auto;
            max-width: 1100px;
        }
        .login-container {
            border: 2px solid green;
        }

        /* Header & Tabs */
        .header {
            display: none;
            background-color: green;
            color: white;
            padding: 10px 15px;
        }
        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            background-color: #e5ffe5;
            padding: 10px;
            border-bottom: 2px solid green;
            gap: 10px;
        }
        .tab {
            padding: 8px 12px;
            color: green;
            text-decoration: none;
            border: 1px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
        }
        .tab:hover {
            background-color: green;
            color: white;
            border-color: green;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e5ffe5;
            color: green;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid white;
        }
        .header-right button {
            background: white;
            color: green;
            border-radius: 5px;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
        }
        .header-right button:hover {
            background: #e5ffe5;
        }

        .error-message {
            color: red;
            text-align: center;
        }

        /* Regal-Listen */
        .regal-list {
            display: none;
            padding: 10px;
            background-color: white;
            border: 1px solid green;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
            max-width: 1100px;
        }
        .regal-item {
            padding: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .regal-item:hover {
            background-color: #e5ffe5;
            border: 1px solid green;
        }

        /* Karten / Kästchen */
        .card {
            border: 1px solid #d0d0d0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #ffffff;
        }
        .card h3 {
            margin-top: 0;
            color: green;
        }

        /* Eingabe-Bereich */
        .regal-title {
            text-align: center;
            color: green;
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0 5px 0;
            border: 1px solid green;
            border-radius: 5px;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
        }
        .small-label {
            font-size: 12px;
            color: #555;
        }
        .field-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        .field-group {
            flex: 1 1 160px;
            min-width: 140px;
        }
        .field-group label {
            display: block;
            font-size: 13px;
            margin-bottom: 3px;
        }
        .field-group input[type="text"],
        .field-group select {
            width: 100%;
            padding: 5px 6px;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 13px;
        }
        .field-group button.plus-btn {
            margin-left: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #f4f4f4;
            cursor: pointer;
            font-size: 13px;
        }
        .field-group button.plus-btn:hover {
            background-color: #e5ffe5;
        }

        /* Ampel */
        .ampel-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .ampel-option {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
        }
        .ampel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #666;
        }
        .ampel-gruen-dot { background-color: #6cc070; }
        .ampel-orange-dot { background-color: #f6c26b; }
        .ampel-rot-dot { background-color: #f28a82; }

        .mangel-uebernehmen-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .mangel-uebernehmen-btn {
            padding: 8px 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background-color: green;
            color: white;
            font-size: 13px;
        }
        .mangel-uebernehmen-btn:hover {
            background-color: #0a7a0a;
        }

        .damage-count {
            color: red;
            font-weight: bold;
            font-size: 13px;
            margin-top: 3px;
        }

        /* Fotos */
        .photos {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .photo {
            position: relative;
            margin: 5px;
        }
        .photo img {
            width: 120px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .remove-photo {
            position: absolute;
            top: 0;
            right: 0;
            color: red;
            cursor: pointer;
            display: none;
            background: #fff;
            border-radius: 50%;
            padding: 0 4px;
            font-size: 12px;
        }
        .photo:hover .remove-photo {
            display: block;
        }

        /* E-Mail */
        .email-section h3 {
            margin-top: 0;
        }
        .email-section button,
        .email-section select {
            padding: 6px;
            margin: 4px 0;
        }
        .email-inline-controls {
            display: none;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Profil */
        .profile-container h2 {
            text-align: center;
            color: green;
        }
        .profile-container input {
            width: 100%;
            padding: 6px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .profile-container button {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background-color: green;
            color: white;
            margin-top: 5px;
        }

        .info-message {
            color: green;
            text-align: center;
            margin-top: 5px;
        }
        .small-link {
            text-align: center;
            margin-top: 10px;
        }
        .small-link span {
            color: green;
            cursor: pointer;
        }
        .small-link span:hover {
            text-decoration: underline;
        }

        /* Modal Erstlogin */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal {
            background: white;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        .modal h3 {
            margin-top: 0;
            color: green;
        }
        .modal input {
            width: 100%;
            padding: 6px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .modal button {
            margin-top: 10px;
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background-color: green;
            color: white;
        }
        .modal-error {
            color: red;
            margin-top: 5px;
        }

        /* Tabelle Mängel */
        .mangel-table-container {
            overflow-x: auto;
        }
        table.mangel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        table.mangel-table th,
        table.mangel-table td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        table.mangel-table th {
            background-color: #e5ffe5;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        table.mangel-table input[type="date"] {
            font-size: 11px;
            padding: 2px 4px;
        }

        /* Ampel-Farben Zeilen */
        .row-ampel-gruen { background-color: #d8f5d0; }
        .row-ampel-orange { background-color: #ffe9c6; }
        .row-ampel-rot { background-color: #ffd6d6; }

        /* Aktion / Hover-Menü */
        .action-menu {
            position: relative;
            display: inline-block;
        }
        .action-icon {
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
        }
        .action-buttons {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            white-space: nowrap;
            z-index: 10;
        }
        .action-menu:hover .action-buttons {
            display: block;
        }
        .action-buttons button {
            display: block;
            width: 100%;
            border: none;
            background: none;
            padding: 3px 6px;
            text-align: left;
            font-size: 12px;
            cursor: pointer;
        }
        .action-buttons button:hover {
            background-color: #e5ffe5;
        }

        @media (max-width: 800px) {
            .header-inner {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div class="login-container">
        <h2>Login</h2>
        <form onsubmit="return validateLogin()">
            <input type="text" id="username" placeholder="Benutzername" required>
            <input type="password" id="password" placeholder="Passwort" required>
            <input type="submit" value="Einloggen">
        </form>
        <p id="error-message" class="error-message"></p>
        <div class="small-link">
            <span onclick="alert('Passwort-Reset kommt ggf. später dazu. Bitte aktuell den Admin kontaktieren.')">
                Passwort vergessen?
            </span>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header" id="header">
        <div class="header-inner">
            <div>
                <h1 style="margin:0;">Regalprüfung – Freytag &amp; Petersen Köln</h1>
            </div>
            <div class="header-right">
                <div id="user-avatar" class="user-avatar" title="Profil öffnen" onclick="showProfile()"></div>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
        <div class="tabs">
            <div class="tab" onclick="showWelcome()">Startseite</div>
            <div class="tab" onclick="toggleRegalList('B')">B-Halle</div>
            <div class="tab" onclick="toggleRegalList('C')">C-Halle</div>
            <div class="tab">Backland</div>
            <div class="tab">Kulturverein</div>
            <div class="tab">Plattenabteilung</div>
        </div>
    </div>

    <!-- REGAL-LISTEN -->
    <div class="regal-list" id="regal-list-B">
        <h3>Regale in der B-Halle</h3>
        <div class="regal-item" onclick="openRegal(201)">Regal 201</div>
        <div class="regal-item" onclick="openRegal(202)">Regal 202</div>
        <div class="regal-item" onclick="openRegal(203)">Regal 203</div>
        <div class="regal-item" onclick="openRegal(204)">Regal 204</div>
        <div class="regal-item" onclick="openRegal(205)">Regal 205</div>
        <div class="regal-item" onclick="openRegal(206)">Regal 206</div>
        <div class="regal-item" onclick="openRegal(207)">Regal 207</div>
        <div class="regal-item" onclick="openRegal(208)">Regal 208</div>
        <div class="regal-item" onclick="openRegal(210)">Regal 210</div>
        <div class="regal-item" onclick="openRegal(211)">Regal 211</div>
    </div>

    <div class="regal-list" id="regal-list-C">
        <h3>Regale in der C-Halle</h3>
        <div class="regal-item" onclick="openRegal(301)">Regal 301</div>
        <div class="regal-item" onclick="openRegal(302)">Regal 302</div>
        <div class="regal-item" onclick="openRegal(303)">Regal 303</div>
        <div class="regal-item" onclick="openRegal(304)">Regal 304</div>
        <div class="regal-item" onclick="openRegal(305)">Regal 305</div>
        <div class="regal-item" onclick="openRegal(306)">Regal 306</div>
        <div class="regal-item" onclick="openRegal(307)">Regal 307</div>
        <div class="regal-item" onclick="openRegal(308)">Regal 308</div>
        <div class="regal-item" onclick="openRegal(310)">Regal 310</div>
        <div class="regal-item" onclick="openRegal(311)">Regal 311</div>
        <div class="regal-item" onclick="openRegal(312)">Regal 312</div>
    </div>

    <!-- START -->
    <div class="welcome-container" id="welcome-container">
        <p>Willkommen im Regalprüfungssystem. Bitte wählen Sie eine Halle und ein Regal aus.</p>
        <p>Beim ersten Login (außer Admin) müssen Passwort und E-Mail gesetzt werden.</p>
    </div>

    <!-- REGAL-SEITE -->
    <div class="regal-container" id="regal-container">
        <h2 class="regal-title" id="regal-title">Regal 201</h2>

        <!-- Kasten: Mängel erfassen -->
        <div class="card">
            <h3>Mängel erfassen</h3>
            <div class="small-label">Beschreibe hier den Mangel / die Bemerkung:</div>
            <textarea id="damage-input" placeholder="Mängel und Schäden eintragen..."></textarea>
            <div class="damage-count">Mängel erfasst: <span id="mangel-count">0</span></div>

            <div class="field-row">
                <div class="field-group">
                    <label for="platz-input">Platz *</label>
                    <input type="text" id="platz-input" placeholder="z.B. 03">
                </div>
                <div class="field-group">
                    <label for="etage-input">Etage *</label>
                    <input type="text" id="etage-input" placeholder="z.B. 02">
                </div>
                <div class="field-group">
                    <label for="pruefgegenstand-select">Prüfgegenstand *</label>
                    <div style="display:flex;align-items:center;">
                        <select id="pruefgegenstand-select"></select>
                        <button type="button" class="plus-btn" onclick="addCustomOption('pruefgegenstand')">+</button>
                    </div>
                </div>
                <div class="field-group">
                    <label for="beschaedigung-select">Beschädigung *</label>
                    <div style="display:flex;align-items:center;">
                        <select id="beschaedigung-select"></select>
                        <button type="button" class="plus-btn" onclick="addCustomOption('beschaedigung')">+</button>
                    </div>
                </div>
            </div>

            <div class="field-row">
                <div class="field-group">
                    <label for="massnahme-select">Maßnahme *</label>
                    <div style="display:flex;align-items:center;">
                        <select id="massnahme-select"></select>
                        <button type="button" class="plus-btn" onclick="addCustomOption('massnahme')">+</button>
                    </div>
                </div>
                <div class="field-group">
                    <label>Ampel *</label>
                    <div class="ampel-group">
                        <label class="ampel-option">
                            <span class="ampel-dot ampel-gruen-dot"></span>
                            <input type="radio" name="ampel" value="Grün"> Grün
                        </label>
                        <label class="ampel-option">
                            <span class="ampel-dot ampel-orange-dot"></span>
                            <input type="radio" name="ampel" value="Orange"> Orange
                        </label>
                        <label class="ampel-option">
                            <span class="ampel-dot ampel-rot-dot"></span>
                            <input type="radio" name="ampel" value="Rot"> Rot
                        </label>
                    </div>
                </div>
            </div>

            <div class="mangel-uebernehmen-row">
                <button type="button" class="mangel-uebernehmen-btn" onclick="addMangel()">Mängel übernehmen</button>
            </div>
        </div>

        <!-- Kasten: Fotos & E-Mail -->
        <div class="card">
            <h3>Fotos &amp; E-Mailbenachrichtigung</h3>

            <h4 style="margin-bottom:4px;">Fotos hinzufügen</h4>
            <input type="file" id="photo-upload" accept="image/*" onchange="addPhoto(event)">
            <div class="photos" id="photo-gallery"></div>

            <div class="email-section" style="margin-top:15px;">
                <h4 style="margin-top:10px;">E-Mailbenachrichtigung</h4>
                <button type="button" onclick="showEmailControls()">E-Mailbenachrichtigung senden</button>
                <div id="email-controls" class="email-inline-controls">
                    <select id="email-select"></select>
                    <button type="button" onclick="sendEmailNotification()">E-Mail erstellen</button>
                    <span id="email-info" style="font-size:12px;color:#555;"></span>
                </div>
            </div>
        </div>

        <!-- Kasten: Mängelübersicht -->
        <div class="card">
            <h3>Mängelübersicht</h3>
            <div class="mangel-table-container">
                <table class="mangel-table" id="mangel-table">
                    <thead>
                        <tr>
                            <th>Regal</th>
                            <th>Platz</th>
                            <th>Etage</th>
                            <th>Prüfgegenstand</th>
                            <th>Beschädigung</th>
                            <th>Maßnahme</th>
                            <th>Ampel</th>
                            <th>Bemerkung</th>
                            <th>Bild</th>
                            <th>Prüfer</th>
                            <th>Datum</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="mangel-table-body">
                        <!-- Einträge kommen hierhin -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PROFIL -->
    <div class="profile-container" id="profile-container">
        <h2>Profil – E-Mail &amp; Passwort</h2>
        <form onsubmit="return changePasswordAndEmail(event)">
            <input type="password" id="profile-old-password" placeholder="Aktuelles Passwort" required>
            <input type="password" id="profile-new-password" placeholder="Neues Passwort" required>
            <input type="password" id="profile-new-password2" placeholder="Neues Passwort bestätigen" required>
            <input type="email" id="profile-email" placeholder="E-Mail-Adresse" required>
            <button type="submit">Speichern</button>
        </form>
        <p id="profile-message" class="info-message"></p>
    </div>

    <!-- ERSTLOGIN MODAL -->
    <div class="modal-backdrop" id="first-login-backdrop">
        <div class="modal">
            <h3>Erstes Login – Passwort &amp; E-Mail setzen</h3>
            <p>Bitte vergeben Sie ein neues Passwort und hinterlegen Sie Ihre E-Mail-Adresse.</p>
            <input type="password" id="first-new-password" placeholder="Neues Passwort" required>
            <input type="password" id="first-new-password2" placeholder="Neues Passwort bestätigen" required>
            <input type="email" id="first-email" placeholder="E-Mail-Adresse" required>
            <button onclick="completeFirstLogin()">Speichern</button>
            <div id="first-login-error" class="modal-error"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentRegal = null;

        const USERS_KEY = 'regal_users_v3';

        const defaultUsers = [
            { username: 'jschwade',  password: '1234', email: '', mustChangePassword: true },
            { username: 'jheller',   password: '1234', email: '', mustChangePassword: true },
            { username: 'dlapusata', password: '1234', email: '', mustChangePassword: true },
            { username: 'adormehl',  password: '1234', email: '', mustChangePassword: true },
            { username: 'qlobbene',  password: '1234', email: '', mustChangePassword: true },
            { username: 'admin',     password: 'IGEPA', email: '', mustChangePassword: false }
        ];

        // Auswahl-Listen
        let pruefgegenstandOptions = [
            'Fußplatte',
            'Diagonalstrebe',
            'Vertikalstrebe',
            'Stütze (Rahmenprofil)',
            'Traverse (Holm)',
            'Verankerung',
            'Diagonalverband',
            'Belastungsangaben',
            'Eckanfahrschutz',
            'Lotrechterstand',
            'Regalboden',
            'Herabfallschutz',
            'Sicherungsstift',
            'Regalschiene'
        ];
        let beschaedigungOptions = [
            'Beschädigt',
            'Fehlt',
            'Falsche Einlagerung',
            'Schiefer Stand'
        ];
        let massnahmeOptions = [
            'Montieren',
            'Ersetzen',
            'Richtig Einlagern',
            'Reparieren'
        ];

        function initUsers() {
            const existing = localStorage.getItem(USERS_KEY);
            if (!existing) {
                localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
            }
        }

        function getUsers() {
            const data = localStorage.getItem(USERS_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveUsers(users) {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        function updateAvatar() {
            const avatar = document.getElementById('user-avatar');
            if (!currentUser) {
                avatar.textContent = '';
                return;
            }
            const name = currentUser.username || '';
            const initials = name.substring(0, 2).toUpperCase();
            avatar.textContent = initials;
        }

        function hideAllMainContainers() {
            document.getElementById('welcome-container').style.display = 'none';
            document.getElementById('regal-container').style.display = 'none';
            document.getElementById('profile-container').style.display = 'none';
            const allRegalLists = document.querySelectorAll('.regal-list');
            allRegalLists.forEach(list => list.style.display = 'none');
        }

        function validateLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const users = getUsers();
            const found = users.find(u => u.username === username && u.password === password);

            if (!found) {
                document.getElementById('error-message').innerText = 'Ungültige Anmeldedaten!';
                return false;
            }

            currentUser = found;
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('header').style.display = 'block';
            updateAvatar();
            document.getElementById('error-message').innerText = '';
            showWelcome();

            if (currentUser.mustChangePassword) {
                showFirstLoginModal();
            }

            return false;
        }

        function logout() {
            currentUser = null;
            hideAllMainContainers();
            document.getElementById('header').style.display = 'none';
            document.querySelector('.login-container').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showWelcome() {
            hideAllMainContainers();
            document.getElementById('welcome-container').style.display = 'block';
        }

        function toggleRegalList(hall) {
            hideAllMainContainers();
            const regalList = document.getElementById('regal-list-' + hall);
            regalList.style.display = 'block';
        }

        function openRegal(regalNum) {
            if (!currentUser) {
                alert('Bitte zuerst einloggen.');
                return;
            }
            currentRegal = regalNum;
            hideAllMainContainers();
            document.getElementById('regal-title').innerText = 'Regal ' + regalNum;
            document.getElementById('regal-container').style.display = 'block';

            document.getElementById('email-controls').style.display = 'none';
            document.getElementById('email-info').textContent = '';
        }

        function showProfile() {
            if (!currentUser) {
                alert('Bitte zuerst einloggen.');
                return;
            }
            hideAllMainContainers();
            document.getElementById('profile-container').style.display = 'block';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-old-password').value = '';
            document.getElementById('profile-new-password').value = '';
            document.getElementById('profile-new-password2').value = '';
            document.getElementById('profile-message').textContent = '';
        }

        // Erstlogin
        function showFirstLoginModal() {
            document.getElementById('first-new-password').value = '';
            document.getElementById('first-new-password2').value = '';
            document.getElementById('first-email').value = currentUser.email || '';
            document.getElementById('first-login-error').textContent = '';
            document.getElementById('first-login-backdrop').style.display = 'flex';
        }

        function completeFirstLogin() {
            const pw1 = document.getElementById('first-new-password').value;
            const pw2 = document.getElementById('first-new-password2').value;
            const email = document.getElementById('first-email').value.trim();
            const err = document.getElementById('first-login-error');
            err.textContent = '';

            if (!pw1 || !pw2 || !email) {
                err.textContent = 'Bitte alle Felder ausfüllen.';
                return;
            }
            if (pw1 !== pw2) {
                err.textContent = 'Die Passwörter stimmen nicht überein.';
                return;
            }
            if (pw1.length < 4) {
                err.textContent = 'Das Passwort sollte mindestens 4 Zeichen lang sein.';
                return;
            }
            if (!email.includes('@')) {
                err.textContent = 'Bitte eine gültige E-Mail eingeben.';
                return;
            }

            const users = getUsers();
            const idx = users.findIndex(u => u.username === currentUser.username);
            if (idx === -1) {
                err.textContent = 'Benutzer nicht gefunden.';
                return;
            }

            users[idx].password = pw1;
            users[idx].email = email;
            users[idx].mustChangePassword = false;
            saveUsers(users);
            currentUser = users[idx];
            updateAvatar();

            document.getElementById('first-login-backdrop').style.display = 'none';
            alert('Passwort und E-Mail wurden gespeichert.');
        }

        // Profil: Passwort + E-Mail
        function changePasswordAndEmail(event) {
            event.preventDefault();
            if (!currentUser) {
                alert('Bitte zuerst einloggen.');
                return false;
            }

            const oldPw = document.getElementById('profile-old-password').value;
            const newPw1 = document.getElementById('profile-new-password').value;
            const newPw2 = document.getElementById('profile-new-password2').value;
            const email  = document.getElementById('profile-email').value.trim();
            const msg    = document.getElementById('profile-message');
            msg.textContent = '';

            if (oldPw !== currentUser.password) {
                msg.textContent = 'Aktuelles Passwort ist falsch.';
                return false;
            }
            if (!newPw1 || !newPw2 || !email) {
                msg.textContent = 'Bitte alle Felder ausfüllen.';
                return false;
            }
            if (newPw1 !== newPw2) {
                msg.textContent = 'Die neuen Passwörter stimmen nicht überein.';
                return false;
            }
            if (newPw1.length < 4) {
                msg.textContent = 'Das neue Passwort sollte mindestens 4 Zeichen haben.';
                return false;
            }
            if (!email.includes('@')) {
                msg.textContent = 'Bitte eine gültige E-Mail eingeben.';
                return false;
            }

            const users = getUsers();
            const idx   = users.findIndex(u => u.username === currentUser.username);
            if (idx === -1) {
                msg.textContent = 'Benutzer nicht gefunden.';
                return false;
            }

            users[idx].password = newPw1;
            users[idx].email    = email;
            saveUsers(users);
            currentUser = users[idx];
            msg.textContent = 'Passwort und E-Mail wurden gespeichert.';
            return false;
        }

        // Fotos
        function addPhoto(event) {
            const photoGallery = document.getElementById('photo-gallery');
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const photoDiv = document.createElement('div');
                photoDiv.classList.add('photo');
                photoDiv.innerHTML =
                    '<img src="' + e.target.result + '" alt="Foto">' +
                    '<span class="remove-photo" onclick="removePhoto(this)">X</span>';
                photoGallery.appendChild(photoDiv);
            };

            if (file) reader.readAsDataURL(file);
        }

        function removePhoto(element) {
            element.parentElement.remove();
        }

        // Mängel-Zähler basiert auf Tabellenzeilen
        function updateMangelCount() {
            const tbody = document.getElementById('mangel-table-body');
            document.getElementById('mangel-count').innerText = tbody.rows.length;
        }

        // Auswahl-Listen initial befüllen
        function populateSelectOptions() {
            const pSel = document.getElementById('pruefgegenstand-select');
            const bSel = document.getElementById('beschaedigung-select');
            const mSel = document.getElementById('massnahme-select');

            function fill(select, arr) {
                select.innerHTML = '';
                const emptyOpt = document.createElement('option');
                emptyOpt.value = '';
                emptyOpt.textContent = '-- Bitte wählen --';
                select.appendChild(emptyOpt);
                arr.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    select.appendChild(opt);
                });
            }
            fill(pSel, pruefgegenstandOptions);
            fill(bSel, beschaedigungOptions);
            fill(mSel, massnahmeOptions);
        }

        function addCustomOption(type) {
            const label = type === 'pruefgegenstand' ? 'neuen Prüfgegenstand'
                        : type === 'beschaedigung' ? 'neue Beschädigungsart'
                        : 'neue Maßnahme';
            const value = prompt('Bitte ' + label + ' eingeben:');
            if (!value) return;

            if (type === 'pruefgegenstand') {
                pruefgegenstandOptions.push(value);
            } else if (type === 'beschaedigung') {
                beschaedigungOptions.push(value);
            } else if (type === 'massnahme') {
                massnahmeOptions.push(value);
            }
            populateSelectOptions();

            if (type === 'pruefgegenstand') {
                document.getElementById('pruefgegenstand-select').value = value;
            } else if (type === 'beschaedigung') {
                document.getElementById('beschaedigung-select').value = value;
            } else {
                document.getElementById('massnahme-select').value = value;
            }
        }

        // Mangel in Tabelle übernehmen
        function addMangel() {
            if (!currentRegal) {
                alert('Bitte zuerst ein Regal auswählen.');
                return;
            }
            const platz = document.getElementById('platz-input').value.trim();
            const etage = document.getElementById('etage-input').value.trim();
            const bemerkung = document.getElementById('damage-input').value.trim();
            const pruefgegenstand = document.getElementById('pruefgegenstand-select').value;
            const beschaedigung = document.getElementById('beschaedigung-select').value;
            const massnahme = document.getElementById('massnahme-select').value;
            const ampelEl = document.querySelector('input[name="ampel"]:checked');
            const ampel = ampelEl ? ampelEl.value : '';

            if (!platz || !etage || !bemerkung || !pruefgegenstand || !beschaedigung || !massnahme || !ampel) {
                alert('Bitte alle Pflichtfelder ausfüllen (Platz, Etage, Bemerkung, Prüfgegenstand, Beschädigung, Maßnahme, Ampel).');
                return;
            }

            const tbody = document.getElementById('mangel-table-body');
            const tr = document.createElement('tr');

            // Ampel-Farbe auf Zeile anwenden
            if (ampel === 'Grün') tr.classList.add('row-ampel-gruen');
            if (ampel === 'Orange') tr.classList.add('row-ampel-orange');
            if (ampel === 'Rot') tr.classList.add('row-ampel-rot');

            const photoCount = document.querySelectorAll('#photo-gallery .photo').length;
            const bildText = photoCount > 0 ? photoCount + ' Bild(er)' : '-';

            const pruefer = currentUser ? currentUser.username : '';
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;

            function td(text) {
                const td = document.createElement('td');
                td.textContent = text;
                return td;
            }

            tr.appendChild(td('Regal ' + currentRegal));
            tr.appendChild(td(platz));
            tr.appendChild(td(etage));
            tr.appendChild(td(pruefgegenstand));
            tr.appendChild(td(beschaedigung));
            tr.appendChild(td(massnahme));
            tr.appendChild(td(ampel));
            tr.appendChild(td(bemerkung));
            tr.appendChild(td(bildText));
            tr.appendChild(td(pruefer));

            const tdDate = document.createElement('td');
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = dateStr;
            tdDate.appendChild(dateInput);
            tr.appendChild(tdDate);

            const tdAction = document.createElement('td');
            tdAction.innerHTML = `
                <div class="action-menu">
                    <span class="action-icon" title="Aktionen">⋯</span>
                    <div class="action-buttons">
                        <button type="button" onclick="markMangelRepaired(this)">Repariert</button>
                        <button type="button" onclick="deleteMangel(this)">Entfernen</button>
                    </div>
                </div>
            `;
            tr.appendChild(tdAction);

            tbody.appendChild(tr);
            updateMangelCount();

            // Textfeld leeren, Ampel nicht löschen (damit man mehrere Einträge mit gleichem Status machen kann)
            document.getElementById('damage-input').value = '';
        }

        function markMangelRepaired(btn) {
            const tr = btn.closest('tr');
            if (!tr) return;
            tr.classList.remove('row-ampel-rot', 'row-ampel-orange');
            tr.classList.add('row-ampel-gruen');
            const ampelCell = tr.cells[6];
            if (ampelCell) ampelCell.textContent = 'Grün';
        }

        function deleteMangel(btn) {
            const tr = btn.closest('tr');
            if (!tr) return;
            if (!confirm('Diesen Mangel wirklich entfernen?')) return;
            tr.parentElement.removeChild(tr);
            updateMangelCount();
        }

        // E-Mail
        function showEmailControls() {
            const controls = document.getElementById('email-controls');
            const select   = document.getElementById('email-select');
            const info     = document.getElementById('email-info');
            select.innerHTML = '';
            info.textContent = '';

            const users = getUsers();
            const withEmail = users.filter(u => u.email && u.email.includes('@'));

            if (withEmail.length === 0) {
                alert('Es sind noch keine E-Mail-Adressen hinterlegt.');
                controls.style.display = 'none';
                return;
            }

            withEmail.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.email;
                opt.textContent = u.username + ' (' + u.email + ')';
                select.appendChild(opt);
            });

            controls.style.display = 'flex';
            info.textContent = 'Wähle einen Empfänger aus und klicke auf „E-Mail erstellen“.';
        }

        function sendEmailNotification() {
            if (!currentRegal) {
                alert('Bitte zuerst ein Regal auswählen.');
                return;
            }
            const select = document.getElementById('email-select');
            const email  = select.value;
            if (!email) {
                alert('Bitte einen Empfänger auswählen.');
                return;
            }

            const subject = 'Regalprüfung Regal ' + currentRegal;
            const damageText = document.getElementById('damage-input').value || '(Bemerkung siehe Tabelle / derzeitige Notiz)';
            const bodyLines = [
                'Hallo,',
                '',
                'es gibt eine neue Notiz zur Regalprüfung.',
                '',
                'Regal: ' + currentRegal,
                'Benutzer: ' + (currentUser ? currentUser.username : ''),
                '',
                'Mögliche Bemerkung:',
                damageText,
                '',
                'Viele Grüße'
            ];
            const body = bodyLines.join('\n');

            const mailto =
                'mailto:' + encodeURIComponent(email) +
                '?subject=' + encodeURIComponent(subject) +
                '&body=' + encodeURIComponent(body);

            window.location.href = mailto;
        }

        // Initialisierung
        document.querySelector('.login-container').style.display = 'block';
        initUsers();
        populateSelectOptions();
        updateMangelCount();
    </script>
</body>
</html>
